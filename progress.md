Original prompt: [$develop-web-game](C:\\Users\\陆敬毅\\.codex\\skills\\develop-web-game\\SKILL.md) 复刻一款 steam 游戏，名字叫《super auto pets》

## 2026-02-12
- Initialized project from empty workspace.
- Will build a playable Super Auto Pets inspired web clone with canvas UI and deterministic test hooks.
- TODO: implement shop/team/battle loop.
- Implemented first playable build: menu -> shop -> battle -> next round loop.
- Added pets (ant/fish/beaver/cricket/mosquito/flamingo/camel/kangaroo) and food effects.
- Added controls: click interactions, right-click freeze, R/X/S/E shortcuts, F fullscreen.
- Added deterministic hooks: window.render_game_to_text and window.advanceTime(ms).
- Added local static server (server.js) and Playwright smoke actions (test/actions-smoke.json).
- Code review finding fixed: battle faint cleanup order was unsafe for summon-on-faint and could remove summons or loop; now remove dead unit before faint effects, and rear-target indexing adjusted.
- Tuned level-up threshold for level 3 from 5 to 3 exp to better match SAP behavior.
- Validation loop:
  - `node --check src/game.js` passed.
  - Playwright client runs now succeed via local copy fallback to installed Chrome channel.
  - Scenarios executed: battle-mid, shop-features (freeze/sell/food), round-complete, and explicit battle-screen capture.
  - No console/page errors in new runs.
- Visual inspection completed for latest screenshots:
  - shop UI renders correctly on desktop scale.
  - battle scene visible and consistent with state JSON (mode=battle, teams/log).
- Remaining TODOs / next iteration suggestions:
  - Add more pets/foods and exact SAP-trigger ordering for higher fidelity.
  - Add drag-and-drop UX and mobile-specific layout polish.
  - Add deterministic seeded enemy presets for repeatable balancing tests.
- Iteration 2 in progress:
  - Added player progression state (level/xp), tier unlock by progress, and scalable life loss by round.
  - Expanded pet pool and food pool with new abilities/effects.
  - Added one-battle food buffs and summon synergy hooks.
  - Implemented drag system scaffolding for shop interactions.
  - Next: run full Playwright validation and adjust visuals/text output.
- Validation (iteration 2) complete:
  - `node --check src/game.js` passed.
  - Playwright scenarios passed with no console/page errors:
    - iter2-shop
    - iter2-battle
    - iter2-round
    - iter2-targetless
    - iter2-food-battle
    - iter2-smoke (2 iterations)
- Visual review notes:
  - Shop, battle, and progression HUD (level/xp/tier) render correctly.
  - Tier unlock verified in smoke run: level reached 2 and tier switched to 2 with new tier-2 pets/foods.
  - Drag-capable UX message shown and sell target remains functional.
- Remaining follow-ups:
  - Add dedicated automated drag-path action payload (mouse-down/move/up granularity) when client supports persistent hold motion.
  - Tighten exact SAP trigger ordering and broaden pet roster.
- Added higher-fidelity triggers:
  - New pets: Peacock, Dodo, Penguin, Turtle.
  - New foods: Melon, Chocolate.
  - Added pet EXP helper and chocolate leveling path.
  - Added melon shield and extra start/end-turn trigger behaviors.
- Starting regression test batch now.
- Validation (iteration 3) complete:
  - `node --check src/game.js` passed.
  - Playwright scenarios passed with no console/page errors:
    - iter3-shop
    - iter3-battle
    - iter3-round
    - iter3-smoke (2 iterations)
    - iter3-exp-foods
- Visual review notes:
  - Battle screenshot confirms summon/faint chain still stable after new triggers.
  - Tier progression still unlocks higher-tier units/foods as expected.
  - New mid-tier pets (peacock/rabbit etc.) appear in shop at tier 2+.
- Follow-up TODO:
  - Add deterministic scenario payloads specifically targeting chocolate/melon/dodo/penguin triggers for stricter regression assertions.
  - Continue toward exact SAP priority queue ordering (currently close, not 1:1).

## 2026-02-13
- Iteration 4: trigger queue readability + deterministic scenario capture tuning.
- Fixed trigger noise in battle queue output:
  - Added `hasHurtBehavior` and `hasFaintBehavior` guards so only real hurt/faint abilities enqueue corresponding triggers.
  - Removed misleading trigger entries for pets without relevant hurt/faint behavior (e.g. beaver showing as fake faint/hurt trigger).
  - Standardized `triggerResolved` label formatting to `phase:side:actor [note]`.
- Improved battle observability:
  - Added explicit combat log line when Melon blocks damage.
  - Exposed `battle.resultTime` and `battle.resultHold` in `render_game_to_text` to aid deterministic capture timing.
  - Cleared scenario toast at battle start so battle logs are not visually obscured during scripted validation.
- Refined debug scenario presets for consistent signal:
  - `melon`: fish with melon vs high-attack beaver for guaranteed melon consumption.
  - `dodo`: front fish + dodo vs beaver stats adjusted for stable start-battle buff + trade sequence.
  - `turtle`: turtle/fish/horse vs beaver tuned for reliable turtle faint -> melon handoff before result.
- Updated scenario action timings:
  - `actions-scenario-melon.json`, `actions-scenario-dodo.json`, `actions-scenario-peng.json`, `actions-scenario-turtle.json`.
- Validation completed:
  - `node --check src/game.js` passed.
  - Scenario loop rerun to dedicated folders:
    - `scenario-choco-new`
    - `scenario-melon-new`
    - `scenario-dodo-new`
    - `scenario-peng-new`
    - `scenario-turtle-new`
  - Full regression batch rerun for all `test/actions-*.json` into `output/web-game/iter4-*`; no new console/page error artifacts produced in those iter4 folders.
  - Visual inspection completed for key screenshots:
    - Choco: fish level-up visible in shop.
    - Melon: melon shield consumption visible in battle log and perk removed.
    - Dodo: start-battle dodo buff visible before trades.
    - Penguin: end-turn buff reflected in fish combat stats.
    - Turtle: turtle faint gives melon to fish before follow-up trade.
- Remaining TODO / next iteration suggestions:
  - Add assertion script(s) over `state-0.json` for scenario runs to automatically check trigger/log invariants (currently manual inspection + JSON readback).
  - Continue moving toward closer SAP timing/order fidelity for multi-faint chain edge cases (simultaneous summons + layered hurt/faint cascades).

- Iteration 5: automated scenario assertions added (no longer manual-only verification).
- Added `scripts/run_scenario_assertions.mjs`:
  - Runs scenario actions (`choco/melon/dodo/peng/turtle`) via local `scripts/web_game_playwright_client.js` using the current Node runtime (`process.execPath`).
  - Writes outputs under `output/web-game/scenario-assertions/<scenario>/`.
  - Fails on Playwright error artifacts (`errors-0.json`) and validates `state-0.json` invariants per scenario.
  - Supports optional filtering by scenario name args (example: `node scripts/run_scenario_assertions.mjs melon turtle`).
- Added npm script:
  - `test:scenarios` -> `node ./scripts/run_scenario_assertions.mjs`
- Validation completed:
  - `node --check scripts/run_scenario_assertions.mjs` passed.
  - `node --check src/game.js` passed.
  - `node scripts/run_scenario_assertions.mjs` passed all 5 scenarios.
  - Visual inspection completed for generated scenario assertion screenshots:
    - `output/web-game/scenario-assertions/choco/shot-0.png`
    - `output/web-game/scenario-assertions/melon/shot-0.png`
    - `output/web-game/scenario-assertions/dodo/shot-0.png`
    - `output/web-game/scenario-assertions/peng/shot-0.png`
    - `output/web-game/scenario-assertions/turtle/shot-0.png`
- Remaining TODO / next iteration suggestions:
  - Add one broader command that runs `test:scenarios` + the existing generic `actions-*.json` regression batch in one step.
  - Add assertion coverage for queue ordering details (`battle.triggerResolved`) in chained faint/summon edge cases.

- Iteration 6: one-command full regression pipeline added.
- Added `scripts/run_full_regression.mjs`:
  - Runs `run_scenario_assertions.mjs` first (5 deterministic scenario checks).
  - Then runs all non-scenario `test/actions-*.json` payloads through `scripts/web_game_playwright_client.js`.
  - Writes outputs to `output/web-game/full-regression/<action-name>/`.
  - Fails on non-zero Playwright exit or generated `errors-0.json`.
  - Supports optional action file filter args (example: `node scripts/run_full_regression.mjs actions-smoke.json`).
- Added npm script:
  - `test:regression` -> `node ./scripts/run_full_regression.mjs`
- Validation completed:
  - `node --check scripts/run_full_regression.mjs` passed.
  - `node --check scripts/run_scenario_assertions.mjs` passed.
  - `node scripts/run_full_regression.mjs` passed:
    - scenario assertions: 5/5 pass
    - non-scenario action regressions: 8/8 pass
  - Filter mode validated:
    - `node scripts/run_full_regression.mjs actions-smoke.json` passed.
  - Visual inspection completed for latest regression screenshots:
    - `output/web-game/full-regression/actions-battle-screen/shot-0.png`
    - `output/web-game/full-regression/actions-shop-features/shot-0.png`
    - `output/web-game/full-regression/actions-round-complete/shot-0.png`
- Remaining TODO / next iteration suggestions:
  - Add queue-order assertions for chained edge cases (multi-faint + summon + hurt interleave) directly in scenario assertion script.
  - Consider refactoring shared Playwright runner helpers between `run_scenario_assertions.mjs` and `run_full_regression.mjs` to reduce duplication.

- Iteration 7: bilingual language switch (English/Chinese) implemented.
- Core i18n changes in `src/game.js`:
  - Added i18n dictionaries (`en` / `zh`) for UI text, toasts, and combat log templates.
  - Added display-name maps for pets and foods in Chinese (`PET_NAME_ZH`, `FOOD_NAME_ZH`).
  - Added helpers: `t`, `petDisplayName`, `foodDisplayName`, `perkDisplayName`, `foodEffectDisplayName`, `toggleLanguage`.
  - Added `state.language` (default `en`) and exposed it in `render_game_to_text`.
- Language switch UX:
  - Added visible language toggle button on top bar (`ui.languageBtn`) in shop/battle/gameover.
  - Added language toggle button on menu screen.
  - Added keyboard shortcut `L` to switch language in any mode.
  - Added toast feedback when language changes.
- Localized rendering scope:
  - Top bar pills, section headings, menu copy, battle headers, game-over copy, button labels.
  - Shop card text: pet/food names, level/exp labels, attack/health tokens, food effect labels.
  - Test preset labels and controls hint line.
  - Toasts and battle log entries now route through i18n keys.
- Added dedicated Playwright action for language switch:
  - `test/actions-language-toggle.json`
- Validation completed:
  - `node --check src/game.js` passed.
  - Targeted language toggle run passed:
    - output: `output/web-game/language-toggle/`
    - state confirms `"language":"zh"` and localized names/toast.
  - Full regression rerun passed after i18n changes:
    - `node scripts/run_full_regression.mjs`
    - scenario assertions: 5/5 pass
    - non-scenario actions: 9/9 pass (includes new `actions-language-toggle.json`)
  - Visual inspection completed for updated language UI:
    - `output/web-game/language-toggle/shot-0.png`
    - `output/web-game/lang-layout-smoke2/shot-0.png`
    - `output/web-game/lang-layout-zh2/shot-0.png`
- Remaining TODO / next iteration suggestions:
  - Add persistence for language preference (localStorage) so reload keeps user-selected language.
  - Expand i18n into automated assertions (for example asserting critical Chinese labels after toggle).

- Iteration 8: language preference persistence implemented.
- Added localStorage persistence in `src/game.js`:
  - `LANGUAGE_STORAGE_KEY = "sap_clone_language"`
  - `persistLanguagePreference()` writes selected language on toggle.
  - `restoreLanguagePreference()` restores saved language at startup.
  - Startup now calls `restoreLanguagePreference()` before first render.
- Behavior:
  - Toggling via button or `L` still updates UI immediately.
  - Refreshing page keeps previously selected language (`en`/`zh`).
  - Storage failures (private mode / blocked storage) fail safely and keep default `en`.
- Validation completed:
  - `node --check src/game.js` passed.
  - Persistence verification script (Playwright + chrome channel) passed:
    - before reload: `storage=zh`, `language=zh`
    - after reload: `storage=zh`, `language=zh`
  - Full regression rerun passed:
    - scenario assertions: 5/5
    - non-scenario actions: 9/9

- Iteration 9: click-card attribute popover implemented (shop + battle).
- Added inspect system in `src/game.js`:
  - New inspect state: `state.inspectCard` with source/slot anchor metadata.
  - New helpers: `setInspectCard`, `clearInspectCard`, `resolveInspectCard`, `compactInspectCard`.
  - Clicking cards now opens a floating detail panel:
    - Shop team pets
    - Shop pet cards
    - Shop food cards
    - Battle friendly/enemy cards
  - Clicking empty area closes panel; `Esc` also closes panel.
  - Panel auto-clears on turn/battle transitions (`beginShopTurn`, `startBattle`, `finishBattle`, `resetGame`).
- Added rich bilingual detail copy:
  - Ability names/descriptions (EN/ZH)
  - Food effect descriptions (EN/ZH)
  - Perk descriptions (EN/ZH)
  - Source/type/tier/stat labels + close hint.
- Rendering updates:
  - Added battle slot geometry constants and reused them for both drawing and click hit-testing.
  - Added `drawInspectPanel()` overlay rendering with wrapped detail text.
- State observability:
  - Exposed current inspected card in `render_game_to_text` as `inspectCard` payload.
- Fixes found during review loop:
  - Battle inspect panel showed `Exp: undefined` for battle clones; fixed by carrying `exp` into `cloneBattlePet` and summon templates.
  - Summoned token tier display normalized (fallback tier from 0 to 1).
- Added regression action payload:
  - `test/actions-card-inspect.json` (covers shop inspect, battle inspect, close behavior, and final deterministic inspect snapshot).
- Validation completed:
  - `node.exe --check src/game.js` passed.
  - Targeted inspect run passed:
    - `output/web-game/card-inspect/` (state includes non-null `inspectCard`, no error artifacts).
  - Extra zh visual check passed:
    - `output/web-game/card-inspect-zh/shot-0.png` shows Chinese inspect content.
  - Full regression rerun passed:
    - `node.exe ./scripts/run_full_regression.mjs`
    - scenario assertions: 5/5 pass
    - action regressions: 10/10 pass (includes new `actions-card-inspect.json`).
- Remaining follow-up suggestions:
  - Improve English wrapping to prefer word boundaries (current wrapper is char-based, readable but can split words).
  - Optionally add keyboard shortcut to cycle inspect targets in battle for faster debugging.

- Iteration 10: interaction/battle UX pass aligned to 6-point plan.
- Core gameplay/UI updates in `src/game.js`:
  - Moved shop controls to bottom centered row (`Reroll / Freeze / Sell / End Turn`) and kept keyboard shortcuts unchanged.
  - Added persistent card status badges for active effects (perk / honey-bee summon / temp buff) on shop and battle cards.
  - Battle result now requires explicit click confirmation (`awaitingResultConfirm`) before returning to next shop round.
  - Combat log rendering now wraps + clips inside panel bounds with dynamic max-line calculation and overflow ellipsis.
  - Added lightweight battle animation pipeline (lunge -> impact -> resolve -> shift -> idle) with front offsets and backline shift interpolation.
  - Inspect panel upgraded to strict modal behavior:
    - click inside panel: consume only
    - click outside panel: close and consume (no click-through)
    - shop pointer down path also respects modal interception before drag/select logic.
  - Added modal backdrop tint while inspect panel is open.
- Regression/action updates:
  - Updated bottom-button coordinates in action payloads (shop/battle/scenario files from prior pass).
  - Adjusted `test/actions-scenario-choco.json` for strict modal timing (separate close-click and apply-click).
- Validation completed:
  - `node.exe --check src/game.js` passed.
  - `node.exe scripts/run_scenario_assertions.mjs` passed (5/5).
  - `node.exe scripts/run_full_regression.mjs` passed:
    - scenario assertions: 5/5 pass
    - action regressions: 10/10 pass
  - Targeted behavior checks:
    - result-confirm hold verified: `output/web-game/verify-result-confirm/state-0.json` shows `mode=battle`, `awaitingResultConfirm=true`; screenshot shows "Click anywhere to continue".
    - strict inspect modal verified: `output/web-game/verify-modal-block/state-0.json` remains `mode=shop`, `battle=null` after clicking End Turn while modal open (no click-through).
    - animation mid-phase verified: `output/web-game/verify-anim7/state-0.json` shows `battle.anim.phase=\"shift\"`, `hasShift=true`.
  - Visual inspection completed for key screenshots:
    - `output/web-game/full-regression/actions-shop-features/shot-0.png`
    - `output/web-game/full-regression/actions-food-battle/shot-0.png`
    - `output/web-game/full-regression/actions-battle-mid/shot-0.png`
    - `output/web-game/full-regression/actions-round-complete/shot-0.png`
    - `output/web-game/full-regression/actions-card-inspect/shot-0.png`
- Iteration 11: full asset/config pipeline runtime integration (configs.xlsx-driven catalog) completed.
- Data/runtime wiring:
  - Added `index.html` preload of `src/game_data.generated.js` before `src/game.js`.
  - Added npm script `build:game-data` using fixed Python path:
    - `C:/Users/陆敬毅/AppData/Local/Programs/Python/Python312/python.exe scripts/build_game_catalog.py`
  - In `src/game.js`, replaced hardcoded pools with config-driven loading via `window.__GAME_DATA`.
  - Added runtime indexes (pack/id/kind maps), plus active pack state and localStorage persistence (`sap_clone_pack_key`).
  - Added menu pack selector (6 packs) and shop/enemy pool filtering by `activePackKey + tier`.
- Entity/model changes:
  - `createPet/createFood` now instantiate from generated catalog records and carry metadata (`icon`, `packKey`, hints, impl status, tier).
  - Added placeholder food effect execution branch (`placeholder_stat_buff`) with tier-based buff values from config.
  - Inspect details now include pack and prioritize config hints; placeholder ability/effect explicitly shows not-implemented notice.
- Rendering/resource changes:
  - Added icon image cache and unified icon-first rendering path for shop pet, shop food, battle cards.
  - Added safe fallback for Playwright file-url regression mode:
    - when protocol is `file:`, skip external image draw to avoid tainted-canvas screenshot failures.
    - when protocol is `http:`, real icons render normally.
- Observability:
  - `render_game_to_text()` now exposes `activePackKey`, `assetCatalogVersion`, and icon fields in compact pet/food payloads.
- Added action payloads:
  - `test/actions-pack-switch.json`
  - `test/actions-icon-render.json`
  - `test/actions-placeholder-entry.json`
- Validation completed:
  - `node --check src/game.js` passed.
  - `build_game_catalog.py` run passed (`packs=6 pets=360 foods=102`).
  - `node ./scripts/run_full_regression.mjs` passed:
    - scenario assertions 5/5
    - action regressions 13/13 (including new action files)
  - Visual checks passed on latest regression screenshots:
    - `actions-pack-switch`, `actions-icon-render`, `actions-placeholder-entry`, `actions-food-battle`, `actions-battle-mid`, `actions-card-inspect`.
  - Extra HTTP icon validation run passed:
    - `output/web-game/http-icon-render/shot-0.png` confirms real icon rendering in served mode.
- Notes for next iteration:
  - If needed, remove `file:` icon fallback once regression capture pipeline stops relying on canvas `toDataURL` under file URLs.
- Iteration 12: fixed icon rendering fallback behavior.
  - Removed protocol-based icon disable in `src/game.js` so game always attempts to render catalog icons.
  - Hardened Playwright capture path in `scripts/web_game_playwright_client.js` to gracefully handle tainted-canvas `toDataURL` errors and fallback to screenshot capture.
  - Verified icon rendering in both:
    - file URL run: `output/web-game/file-icon-render/shot-0.png`
    - http URL run: `output/web-game/http-icon-render-2/shot-0.png`
- Iteration 13: bug-batch verification and quality fixes (display/icon/description/end-turn confirm).
  - Confirmed end-turn gold confirmation is active:
    - First click on `End Turn` with gold left now keeps `mode=shop`, shows toast, and starts confirm timer.
    - Validation artifact: `output/web-game/verify-end-turn-gold/state-0.json` (`endTurnConfirmTime > 0`, toast present).
  - Confirmed implemented item description priority is fixed:
    - `foodEffectDescription('perk_meat', implemented)` now returns canonical i18n description instead of OCR hint text.
    - Placeholder effect still appends cleaned hint for transparency.
  - Confirmed known icon mismatch fallback is active:
    - `pack1_pet_0018` (`蠕虫`) is now marked `iconMissing=true` in generated data and runtime `createPet` returns `icon: null`.
    - This prevents wrong food icon (apple) from being rendered on that placeholder pet.
  - Data sanity checks:
    - placeholder pets forced to icon fallback by overlap rule: `14`.
  - Notes:
    - Mixed EN UI with some CN placeholder names is expected under current fallback policy (`name_en` missing -> zh fallback).
    - If required next iteration can switch EN fallback to ASCII IDs or curated EN aliases for placeholder entries.
- Iteration 14: EN placeholder-name display cleanup.
  - Updated `localizedEntryName` in `src/game.js`:
    - For EN mode entries missing `name_en` where `name_zh` is CJK, use ASCII fallback IDs from `sourceId/id`.
    - Fallback format now short to avoid card truncation:
      - pet: `P0003`
      - food: `F0002`
  - This removes mixed-language card names on EN UI while preserving CN names in ZH mode.
  - Validation:
    - `node --check src/game.js` passed.
    - Targeted visual check: `output/web-game/verify-en-fallback/shot-0.png` shows EN-safe placeholder labels.
    - Full regression rerun passed:
      - scenario assertions: 5/5
      - action regressions: 13/13
